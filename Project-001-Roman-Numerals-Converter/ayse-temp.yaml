AWSTemplateFormatVersion: 2010-09-09

Description: |
  Roman Numerals Converter Application (Python Flask) deployed on AWS EC2 with Cloudformation.

Parameters:
  myVPC:
    Description: Select your VPC
    Type: AWS::EC2::VPC::Id

  myKeyPair:
    Description: Select your key
    Type: AWS::EC2::KeyPair::KeyName

  myInstanceType:
    Description: Select instance type
    Type: String
    Default: t2.micro
    
Mappings:
  RegionImageMap:
    us-east-1:
      AMI: ami-0dc2d3e4c0f9ebd18
    us-east-2:
      AMI: ami-0233c2d874b811deb
    us-west-1:
      AMI: ami-0ed05376b59b90e46
    us-west-2:
      AMI: ami-0dc8f589abe99f538
    eu-west-1:
      AMI: ami-058b1b7fe545997ae 


Resources:
  mySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enables ssh and http # Required
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      VpcId: !Ref myVPC

  myLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        ImageId: !FindInMap
          - RegionImageMap
          - !Ref AWS::Region
          - AMI  
        InstanceType: !Ref myInstanceType
        KeyName: !Ref myKeyPair
        SecurityGroupIds:
          - !GetAtt mySecurityGroup.GroupId
        
        UserData: !Base64 |
          #! /bin/bash
          yum update -y
          pip3 install flask
          python3 app.py

      
  
Outputs:
  WebsiteUrl:
    Description: Roman Numerals Converter Application URL
    Value: !Join 
       - ''
       - - 'http://'
         - !GetAtt myLaunchTemplate.DNSName

